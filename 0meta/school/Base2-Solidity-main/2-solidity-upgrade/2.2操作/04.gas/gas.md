# Gas

gas 是以太坊协议中的计量单位，用它来计量在以太坊区块链上执行具体操作所要花费的计算量和存储资源。与比特币协议中仅仅以交易数据的字节大小来计算交易费不同，以太坊协议中计算交易费时需要计量由交易和智能合约代码执行所引发的所有计算步骤。

由交易和合约代码触发的每个操作都会消耗固定数量的 gas，以下是黄皮书中的几个例子：

- 相加两个数值需要消耗 3 gas。
- 计算 Keccak-256 哈希需要消耗 30 gas，每 256 位输入数据额外消耗 6 gas。
- 发送一个交易需要消耗 21000 gas。

gas 是以太坊中极其重要的组成部分，它扮演了双重角色：作为以太坊中浮动的价格和矿工奖励之间的缓冲，以及对抗拒绝服务攻击的防范措施。为了防止网络中意外的或者恶意的无限循环以及其他形式的计算浪费，每个交易的创建者都需要设定一个限制来表明他们愿意为交易执行所付出的计算量。gas 系统借此来降低攻击者们发送“垃圾”交易的意愿，因为他们必须为他们所消耗的计算量、带宽和存储资源付出代价。

### 5.4.1 执行阶段的 gas 计量

当需要 EVM 进行计算来完成交易时，第一个 EVM 实例将获得与交易中所指定的 gas 上限相同数量的可用 gas。每个操作码的执行都会消耗 gas，于是这个 EVM 的 gas 供给就会在程序执行过程中相应减少。在每个操作之前，EVM 会检查是否还有足够的 gas 来支付操作的执行。如果已经没有足够的 gas，则执行会被中止，交易也会被撤销。

如果 EVM 中的执行成功结束，没有出现 gas 不足的情况，那么执行中实际消耗的 gas 费用就会被作为交易费支付给矿工。交易费将会基于交易中指定的 gas 价格折算为以太币：

**矿工费=实际消耗的 gas×gas 价格**

由交易提供的剩余 gas 将返还给发送者，同样将会基于交易中指定的 gas 价格折算为以太币：

**剩余 gas=gas 上限-实际 gas 消耗**

**返还的以太币=剩余 gas×gas 价格**

如果一个交易在执行过程中“gas 不足”，操作会被立即中止，并产生“out of gas”异常。

交易也会被撤销，所有对状态的修改都会回滚。

但尽管交易没有成功，发送者仍然需要支付交易费，因为矿工们已经为到发生错误时点的操作付出了计算量，他们理应从这些付出中获得报酬。

### 5.4.2 gas 计量原则

EVM 中的不同操作所花费的 gas 是被仔细选择确定的，以此来在攻击中保护以太坊区块链。操作中包含了越多计算量的操作码其 gas 消耗会越高。比如，执行 SHA3 函数的代价（消耗 30 gas）大概是 ADD 操作（消耗 3 gas）的 10 倍。更重要的是，某些操作，比如 EXP，需要基于操作数的大小额外支付 gas。使用 EVM 的内存和向合约的链上存储保存数据同样是要消耗 gas 的。

真实世界中的资源消耗必须与 gas 消耗相匹配的重要性在 2016 年获得了印证。当时，一个攻击者发现并利用了 gas 消耗与实际资源消耗的不匹配，他生成了很多计算量极其巨大的交易，并使以太坊主网堵塞到几乎停止运转。这个问题最终通过一个硬分叉（代号“Tangerine Whistle”）调整了 gas 消耗才得以解决。

### 5.4.3 gas 消耗和 gas 价格

gas 消耗是对 EVM 所进行的计算和使用的存储的一个计量，与此相应，gas 本身也有一个用以太币来计量的价格。在发送一个交易的时候，发送者需要指定一个他们愿意为每单位 gas 支付的 gas 价格（以以太币为单位），来使市场可以决定这些以太币价格与计算操作的消耗（以 gas 为单位）之间的关系：

**交易费=总 gas 消耗 ×gas 价格（用以太币作为单位）**

以太坊网络中的矿工们在构造新区块的时候可以从处于等待状态的交易中来选取那些 gas 价格较高的交易。为交易提供较高的 gas 价格可以使矿工们更容易选择它们，从而使它们更快地得到确认。

在实际操作的时候，交易的发送者需要指定一个 gas 上限，这个上限应该高于或等于他们希望被使用的 gas 数量。如果 gas 上限高于实际消耗的 gas 数量，发送者会获得剩余数量的返还，因为矿工们应该仅从他们实际付出的工作中获得报酬。

清晰地理解 gas 消耗和 gas 价格的区别非常重要，这里再次说明：

- gas 消耗是执行特定操作所需要的单位 gas 的数量。
- gas 价格是在发送交易到以太坊网络时指定的希望为每单位 gas 所支付的以太币数量。尽管 gas 是有价格的，但它既不能“持有”也不能“花费”。gas 仅在 EVM 内作为对计算工作量的计量而存在。向发送者收取的交易费是用以太币来计算的，它首先会被换算为供 EVM 计量的 gas，而后会以以太币为单位结算为交易费来支付给矿工们。

**负的 gas 消耗**

以太坊鼓励删除使用过的存储变量，这将会计入在合约执行过程中返还的对 gas 使用的消耗。

EVM 中有两个操作带有负的 gas 消耗：

- 删除一个合约（SELFDESTRUCT）会返还 24000 gas。
- 将一个非零值的存储地址设置为 0（SSTORE[x]=0）会返还 15000 gas。为了避免通过返还机制牟利，交易的最大 gas 返还数量被设定为交易中总共消耗的 gas 数量的一半（向下舍入）。

### 5.4.4 区块的 gas 限制

区块的 gas 限制指的是一个区块中的所有交易总共能消耗的最大 gas 数量，它也限定了一个区块中能包含多少交易。

例如，假定有 5 个交易，它们的 gas 上限分别为 30000、30000、40000、50000 和 50000。

如果区块的 gas 限制是 180000，那么任意四个交易都可以包含到一个区块中，第 5 个交易则需要等待后续区块。就像先前讨论过的那样，矿工们决定哪些交易会被包含到一个新区块中。不同的矿工大概会选择不同的组合，这主要是因为他们从网络中接收到这些交易的顺序是不同的。

如果一个矿工尝试包含一个 gas 消耗超过区块 gas 限制的交易，那么这个区块将会被网络拒绝。大多数以太坊客户端会停止处理这个交易，并给出一个类似“transaction exceeds block gas limit”的警告。目前以太坊主网的区块 gas 限制是 800 万，这意味着每个区块大概可以包含 380 个基础交易（每个交易消耗 21000 gas）。

**区块的 gas 限制是多少**

区块的 gas 限制是由网络中的矿工们共同决定的。希望在以太坊网络中挖矿的人可以使用一个挖矿程序，比如 Ethminer，它将会连接到 geth 或者 Parity 客户端。以太坊协议有一个内置的机制允许矿工们对后续区块的 gas 限制进行投票以改变其容量。某个矿工可以提议对区块的 gas 限制做增减最多 1/1024（0.0976%）的调整。投票的结果将会决定一个基于当时网络需求的可变的区块大小。这个机制与默认的挖矿策略是绑定的。在默认的挖矿策略中，矿工们会对 gas 限制进行投票，这个限制至少为 470 万，但实际上是以最近的平均区块 gas 消耗（基于 1024 个区块计算的指数移动平均值）的 150% 为目标的一个数值。
