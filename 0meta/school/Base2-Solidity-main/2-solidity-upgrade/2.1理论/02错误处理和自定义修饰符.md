## é”™è¯¯å¤„ç†

### 1. `require` è¯­å¥

`require` ç”¨äºåœ¨æ‰§è¡Œå‡½æ•°ä¹‹å‰æ£€æŸ¥æ¡ä»¶æ˜¯å¦æ»¡è¶³ã€‚å¦‚æœæ¡ä»¶ä¸æ»¡è¶³ï¼Œ`require` ä¼šæŠ›å‡ºå¼‚å¸¸å¹¶å›æ»šæ‰€æœ‰çŠ¶æ€æ›´æ”¹ã€‚å®ƒé€šå¸¸ç”¨äºéªŒè¯ç”¨æˆ·è¾“å…¥æˆ–å¤–éƒ¨è°ƒç”¨çš„åˆæ³•æ€§ã€‚

#### è¯­æ³•
```solidity
require(æ¡ä»¶, "Error code");
```

#### ç¤ºä¾‹
```solidity
function transfer(address to, uint256 amount) public {
    require(to != address(0), "æ— æ•ˆçš„æ¥æ”¶åœ°å€");
    require(amount > 0, "è½¬è´¦é‡‘é¢å¿…é¡»å¤§äº0");
    // ... è½¬è´¦é€»è¾‘ ...
}
```

#### ç‰¹ç‚¹
- ç”¨äºè¾“å…¥éªŒè¯
- æŠ›å‡ºå¼‚å¸¸æ—¶ä¼šå›æ»šçŠ¶æ€
- å¯ä»¥é™„å¸¦é”™è¯¯ä¿¡æ¯

---

### 2. `assert` è¯­å¥

`assert` ç”¨äºæ£€æŸ¥å†…éƒ¨é€»è¾‘çš„æ­£ç¡®æ€§ï¼Œé€šå¸¸ç”¨äºéªŒè¯åˆçº¦å†…éƒ¨çŠ¶æ€æ˜¯å¦ä¸€è‡´ã€‚å¦‚æœæ¡ä»¶ä¸æ»¡è¶³ï¼Œ`assert` ä¼šæŠ›å‡ºå¼‚å¸¸å¹¶å›æ»šæ‰€æœ‰çŠ¶æ€æ›´æ”¹ã€‚å®ƒé€šå¸¸ç”¨äºè°ƒè¯•å’Œç¡®ä¿åˆçº¦é€»è¾‘çš„æ­£ç¡®æ€§ã€‚

#### è¯­æ³•
```solidity
assert(æ¡ä»¶);
```

#### ç¤ºä¾‹
```solidity
function divide(uint256 a, uint256 b) public pure returns (uint256) {
    uint256 result = a / b;
    assert(b != 0); // ç¡®ä¿é™¤æ•°ä¸ä¸º0
    return result;
}
```

#### ç‰¹ç‚¹
- ç”¨äºå†…éƒ¨é€»è¾‘éªŒè¯
- æŠ›å‡ºå¼‚å¸¸æ—¶ä¼šå›æ»šçŠ¶æ€
- é€šå¸¸ä¸é™„å¸¦é”™è¯¯ä¿¡æ¯

---

### 3. revert å…³é”®å­—

`revert` æ˜¯ Solidity ä¸­ç”¨äº **å›é€€äº¤æ˜“ï¼ˆtransactionï¼‰å¹¶æ¢å¤çŠ¶æ€** çš„ä¸€ä¸ªå…³é”®å­—ã€‚å®ƒç»å¸¸ç”¨äºé”™è¯¯å¤„ç†ï¼Œå½“æŸäº›æ¡ä»¶ä¸æ»¡è¶³æ—¶ç«‹å³ç»ˆæ­¢æ‰§è¡Œå¹¶è¿”è¿˜å‰©ä½™çš„ gasã€‚

---

#### ğŸ§© åŸºæœ¬è¯­æ³•

```solidity
revert();
revert("é”™è¯¯ä¿¡æ¯");
```

---

#### ğŸ§  å·¥ä½œæœºåˆ¶

å½“è°ƒç”¨ `revert()` æ—¶ï¼š

- å½“å‰å‡½æ•°æ‰§è¡Œè¢«ä¸­æ­¢ï¼›
    
- æ‰€æœ‰çŠ¶æ€æ›´æ”¹ï¼ˆåŒ…æ‹¬è°ƒç”¨ä¹‹å‰çš„æ›´æ”¹ï¼‰éƒ½ä¼šè¢«å›æ»šï¼›
    
- æœªä½¿ç”¨çš„ gas ä¼šè¢«é€€è¿˜ç»™è°ƒç”¨è€…ï¼›
    
- å¦‚æœæœ‰é”™è¯¯ä¿¡æ¯ï¼Œä¼šè¢«è¿”å›ç»™è°ƒç”¨è€…ï¼ˆå‰ç«¯æˆ–è°ƒç”¨åˆçº¦å¯ä»¥è¯»å–è¿™ä¸ªä¿¡æ¯ï¼‰ã€‚
    

---

#### ğŸš¨ ä½¿ç”¨åœºæ™¯

1. **æ¡ä»¶æ£€æŸ¥å¤±è´¥**ï¼š
    

```solidity
if (msg.value < price) {
    revert("Insufficient funds");
}
```

2. **é…åˆè‡ªå®šä¹‰é”™è¯¯ä½¿ç”¨**ï¼ˆgas æ›´çœï¼‰ï¼š
    

```solidity
error NotOwner();

function onlyOwner() public view {
    if (msg.sender != owner) {
        revert NotOwner();
    }
}
```


#### è‡ªå®šä¹‰é”™è¯¯
```solidity
// ç®€å•é”™è¯¯ï¼ˆä¸å¸¦å‚æ•°ï¼‰
error Unauthorized();

// å¸¦å‚æ•°çš„é”™è¯¯
error InsufficientBalance(uint256 available, uint256 required);

// å¤æ‚å‚æ•°çš„é”™è¯¯
error TransferFailed(address from, address to, uint256 amount, string reason);
```

**è§¦å‘è‡ªå®šä¹‰é”™è¯¯**

```solidity
function withdraw(uint256 amount) public {
    if (amount > balances[msg.sender]) {
        revert InsufficientBalance(balances[msg.sender], amount);
    }
    // å…¶ä»–é€»è¾‘...
}
```

#### ä¼˜åŠ¿

1. **Gas æ•ˆç‡**ï¼šæ¯”Â `require`/`revert`Â èŠ‚çœçº¦ 50-70% Gas
    
    - æ™®é€š require: ~45 Gas
        
    - è‡ªå®šä¹‰é”™è¯¯: ~20 Gas
        
2. **å‚æ•°åŒ–é”™è¯¯ä¿¡æ¯**ï¼šå¯ä»¥æºå¸¦ä»»æ„æ•°é‡å’Œç±»å‹çš„å‚æ•°
    
3. **ç±»å‹å®‰å…¨**ï¼šç¼–è¯‘å™¨ä¼šæ£€æŸ¥é”™è¯¯ç±»å‹å’Œå‚æ•°åŒ¹é…
    
4. **ABI ç¼–ç **ï¼šè‡ªåŠ¨ç”Ÿæˆé”™è¯¯ç­¾åï¼Œæ–¹ä¾¿å®¢æˆ·ç«¯è§£æ
---

#### ğŸ’¡ ä¾‹å­

```solidity
pragma solidity ^0.8.0;

contract Shop {
    address public owner;
    uint256 public price = 1 ether;

    constructor() {
        owner = msg.sender;
    }

    function buy() public payable {
        if (msg.value < price) {
            revert("Not enough ETH sent");
        }
        // è´­ä¹°é€»è¾‘
    }
}
```

---

### 4. ğŸ” ä¸‰è€…å¯¹æ¯”

| ç‰¹æ€§        | `require`           | `revert`                    | `assert`              |
| --------- | ------------------- | --------------------------- | --------------------- |
| âœ… åŠŸèƒ½      | æ¡ä»¶æ£€æŸ¥ï¼Œä¸æ»¡è¶³åˆ™ç»ˆæ­¢æ‰§è¡Œ       | æ‰‹åŠ¨è§¦å‘ç»ˆæ­¢æ‰§è¡Œï¼Œå¸¦/ä¸å¸¦é”™è¯¯ä¿¡æ¯           | æ£€æŸ¥ç¨‹åºå†…éƒ¨é€»è¾‘æ˜¯å¦**æ°¸è¿œæˆç«‹**    |
| ğŸ¯ ç”¨é€”     | éªŒè¯è¾“å…¥ã€æƒé™ã€è°ƒç”¨çŠ¶æ€        | æ›´çµæ´»åœ°ä¸­æ­¢æ‰§è¡Œ                    | ç”¨æ¥å‘ç°**bug**æˆ–**ä¸å˜é‡å¤±æ•ˆ** |
| ğŸ”„ çŠ¶æ€å›æ»š   | âœ… ä¼šå›æ»š               | âœ… ä¼šå›æ»š                       | âœ… ä¼šå›æ»š                 |
| ğŸ’¸ Gas è¿”è¿˜ | âœ… æœªæ¶ˆè€—çš„ gas ä¼šè¿”è¿˜      | âœ… ä¼šè¿”è¿˜                       | âŒ ä¸è¿”è¿˜ï¼ˆpanicï¼Œé‡å¤§é”™è¯¯ï¼‰     |
| ğŸ“¢ å¯å¸¦ä¿¡æ¯   | âœ… `"é”™è¯¯ä¿¡æ¯"`          | âœ… `"é”™è¯¯ä¿¡æ¯"` æˆ– `error Type()` | âŒ æ— ä¿¡æ¯ï¼ˆåªæœ‰ Panic codeï¼‰  |
| ğŸ§± æ¨èä½¿ç”¨   | å¤–éƒ¨è¾“å…¥æ¡ä»¶ã€requireæƒé™æ£€æŸ¥ç­‰ | ä¸šåŠ¡é€»è¾‘å¤±è´¥ã€è‡ªå®šä¹‰ error æŠ›é”™         | æµ‹è¯• / å†…éƒ¨æ–­è¨€ï¼Œ**æ°¸è¿œä¸è¯¥å¤±è´¥**  |

---

### 5. try-catch è¯­å¥

Solidity ä» 0.6.0 ç‰ˆæœ¬å¼€å§‹å¼•å…¥äº†Â `try-catch`Â è¯­å¥ï¼Œç”¨äºå¤„ç†å¤–éƒ¨å‡½æ•°è°ƒç”¨å’Œåˆçº¦åˆ›å»ºä¸­çš„é”™è¯¯ã€‚è¿™æ˜¯ Solidity ä¸­é”™è¯¯å¤„ç†çš„é‡è¦æœºåˆ¶ä¹‹ä¸€ã€‚

#### ğŸš¨é€‚ç”¨åœºæ™¯

`try-catch`Â åªèƒ½ç”¨äºä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š

1. **å¤–éƒ¨å‡½æ•°è°ƒç”¨**ï¼ˆä½¿ç”¨Â `address`Â è°ƒç”¨æˆ–åˆçº¦å®ä¾‹è°ƒç”¨ï¼‰
    
2. **åˆçº¦åˆ›å»º**ï¼ˆä½¿ç”¨Â `new`Â å…³é”®å­—ï¼‰

#### å®Œæ•´çš„ try-catch ç»“æ„

```solidity
try externalContract.someFunction(arg1, arg2) returns (uint256 result) {
    // è°ƒç”¨æˆåŠŸæ—¶æ‰§è¡Œçš„ä»£ç 
    // å¯ä»¥ä½¿ç”¨è¿”å›å€¼ result
} catch Error(string memory reason) {
    // å½“ revert(reasonString) æˆ– require(false, reasonString) è¢«è°ƒç”¨æ—¶
    // å¯ä»¥è®¿é—® reason
} catch Panic(uint errorCode) {
    // å½“å‘ç”Ÿ panic é”™è¯¯æ—¶ï¼ˆå¦‚é™¤ä»¥é›¶ã€æ•°ç»„è¶Šç•Œç­‰ï¼‰
    // errorCode è¡¨ç¤ºé”™è¯¯ç±»å‹
} catch (bytes memory lowLevelData) {
    // å½“é”™è¯¯ä¸ç¬¦åˆä¸Šè¿°ä»»ä½•ç±»å‹æ—¶
    // åŒ…å«ä½çº§é”™è¯¯æ•°æ®
}
```


#### é”™è¯¯ç±»å‹è¯¦è§£

 1. `Error(string memory reason)`

- å¯¹åº”Â `revert("description")`Â æˆ–Â `require(false, "description")`
    
- å¯ä»¥è·å–é”™è¯¯æè¿°å­—ç¬¦ä¸²
    

2.Â `Panic(uint errorCode)`

- å¯¹åº” Solidity çš„ "panic" é”™è¯¯ï¼ˆç±»ä¼¼æ–­è¨€å¤±è´¥ï¼‰
    
- å¸¸è§é”™è¯¯ç ï¼š
    
    - 0x01: æ–­è¨€å¤±è´¥
        
    - 0x11: ç®—æœ¯è¿ç®—æº¢å‡º
        
    - 0x12: é™¤ä»¥é›¶
        
    - 0x21: æ— æ•ˆçš„æ•°ç»„ç´¢å¼•
        
    - 0x31: åˆ†é…è¿‡å¤šå†…å­˜
        
    - 0x32: è°ƒç”¨æœªåˆå§‹åŒ–çš„å†…éƒ¨å‡½æ•°ç±»å‹å˜é‡
        

3. é»˜è®¤çš„Â `catch`Â å—

- æ•è·æ‰€æœ‰å…¶ä»–ç±»å‹çš„é”™è¯¯
    
- åŒ…å«åŸå§‹é”™è¯¯æ•°æ®ï¼ˆbytes ç±»å‹ï¼‰


## è‡ªå®šä¹‰ä¿®é¥°ç¬¦

è‡ªå®šä¹‰ä¿®é¥°ç¬¦ï¼ˆModifierï¼‰ç”¨äºåœ¨å‡½æ•°æ‰§è¡Œå‰æˆ–æ‰§è¡Œåæ·»åŠ é¢å¤–çš„æ£€æŸ¥æˆ–é€»è¾‘ã€‚å®ƒå¯ä»¥å¤ç”¨ä»£ç ï¼Œå¹¶ä¸”å¸¸ç”¨äºæƒé™æ§åˆ¶æˆ–çŠ¶æ€æ£€æŸ¥ã€‚

### è¯­æ³•
```solidity
modifier ä¿®é¥°ç¬¦å {
    // å‰ç½®é€»è¾‘
    _; // æ‰§è¡Œå‡½æ•°ä½“
    // åç½®é€»è¾‘
}
```

### ç¤ºä¾‹
```solidity
contract Owner {
    address public owner;

    constructor() {
        owner = msg.sender;
    }

    // è‡ªå®šä¹‰ä¿®é¥°ç¬¦ï¼Œä»…å…è®¸åˆçº¦æ‰€æœ‰è€…è°ƒç”¨
    modifier onlyOwner {
        require(msg.sender == owner, "ä»…åˆçº¦æ‰€æœ‰è€…å¯è°ƒç”¨");
        _;
    }

    function changeOwner(address newOwner) public onlyOwner {
        owner = newOwner;
    }
}
```

### ç‰¹ç‚¹
- å¯ä»¥å¤ç”¨ä»£ç 
- å¸¸ç”¨äºæƒé™æ§åˆ¶
- å¯ä»¥åœ¨å‡½æ•°æ‰§è¡Œå‰åæ·»åŠ é€»è¾‘


---

## ç»¼åˆç¤ºä¾‹

```solidity
contract Bank {
    mapping(address => uint256) public balances;

    // è‡ªå®šä¹‰ä¿®é¥°ç¬¦ï¼Œæ£€æŸ¥ä½™é¢æ˜¯å¦è¶³å¤Ÿ
    modifier hasSufficientBalance(uint256 amount) {
        require(balances[msg.sender] >= amount, "ä½™é¢ä¸è¶³");
        _;
    }

    // å­˜æ¬¾å‡½æ•°
    function deposit() public payable {
        require(msg.value > 0, "å­˜æ¬¾é‡‘é¢å¿…é¡»å¤§äº0");
        balances[msg.sender] += msg.value;
    }

    // å–æ¬¾å‡½æ•°
    function withdraw(uint256 amount) public hasSufficientBalance(amount) {
        balances[msg.sender] -= amount;
        payable(msg.sender).transfer(amount);
        assert(balances[msg.sender] >= 0); // ç¡®ä¿ä½™é¢ä¸ä¸ºè´Ÿ
    }
}
```

---
